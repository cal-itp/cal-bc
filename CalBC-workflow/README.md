# CalBC-workflow
This folder contains all the necessary scripts and resources to generate dynamic widgets for the California Benefit Costs Analysis. 

- `widgets_helper.py` : Contains all the descriptive information used in the widget creation process including widget titles, subtitles and info description. These helper info are used in `projectinfo_widgets.py` and `modelinputs_widgets.py`. This script also contains function to create info button and to create sections.  

- `parameters.py` : Contains all the fixed set of parameters used throughout the model. This file replicates the `PARAMETERS` sheet of CalBC Sketch model. These parameters are updated as often as USDOT updates [Benefit-Cost guidelines](https://www.transportation.gov/mission/office-secretary/office-policy/transportation-policy/benefit-cost-analysis-guidance) or if new data becomes available. 

- `projectinfo_widgets.py` : This script dynamically generates interactive `input fields` (widgets) for users to enter values, replicating the `1) Project Information` sheet from the Excel version of [CalBC](https://dot.ca.gov/-/media/dot-media/programs/transportation-planning/documents/new-state-planning/transportation-economics/cal-bc/2023-cal-bc/2023-non-federal-model/cal-bc-8-1-sketch-a11y.xlsm). Initially, the `widgets` are pre-filled with default values or left blank. However, if a corresponding Excel cell contains a formula, the script includes functions that replicate this formula's behavior, ensuring the dependent fields are automatically updated whenever any of the input values change. The observation mechanism `.observe` tracks changes in the widgets, automatically recalculating and updating any related fields in real time. While most fields are updated dynamically, users retain the flexibility to manually adjust specific widgets for more precise or customized inputs. The interface is designed with `HBox` and `VBox` containers, offering a clean, intuitive layout, complemented by descriptive `titles`, `subtitles`, and helpful `info` buttons, all powered by `widgets_helper.py`.

- `modelinputs_widgets.py` : Works the same way as `projectinfo_widgets.py`. This script dynamically generates interactive `input fields` (widgets) for users to enter values, replicating the `2) Model Inputs` sheet from the Excel version of [CalBC](https://dot.ca.gov/-/media/dot-media/programs/transportation-planning/documents/new-state-planning/transportation-economics/cal-bc/2023-cal-bc/2023-non-federal-model/cal-bc-8-1-sketch-a11y.xlsm). 

- `travel_time.py` : This code uses the input values added in the widgets generated by `projectinfo_widgets.py` and `modelinputs_widgets.py` to calculate `Travel Time Benefits` of the given project in `Present Value` and `Constant Dollars`. This file replicates the `Travel Time` sheet of CalBC sketch model. 

- `BCA.py`: This code uses the metric benefit value like `Travel Time Benefits` and calculates `Benefit Cost Ratio`

- `Running Widgets.ipynb`: This notebook acts as the primary launcher and integrator for the `CalBC sketch model` interface. It imports and initializes all the input widgets from `projectinfo_widgets.py`, `modelinputs_widgets.py` and `travel_time.py`, ensuring that both sets of inputs are displayed together in a single interactive view. While the layout and individual widget design are handled in the respective scripts, this notebook brings them together into a cohesive form for user interaction. At the end of the notebook, a `Benefit-Cost Ratio (BCR)` widget is included that comes from `BCA.py`, which dynamically reflects the final BCR calculated from user inputs. `Running Widgets.ipynb` is also used as the main entry point for the `Voila application`, transforming the notebook into a clean, code-free web interface for end users to explore and analyze transportation project scenarios using the CalBC model.



## Workflow to Add or Update Widgets
To translate the CalBC Excel model into an interactive widget-based interface, follow the steps below. These instructions will guide you through identifying key inputs, creating widgets, replicating formulas, and organizing the UI for seamless user interaction.

1. Identify widgets you want to include 
    - Open the [CalBC Sketch Model](https://dot.ca.gov/-/media/dot-media/programs/transportation-planning/documents/new-state-planning/transportation-economics/cal-bc/2023-cal-bc/2023-non-federal-model/cal-bc-8-1-sketch-a11y.xlsm)
    - Review the `1) Project Information` and `2) Model Inputs` worksheets in the `CalBC Excel model`. These are the two primary input sheets that will be translated into dynamic, interactive widgets, allowing users to enter values directly through the interface.
    - Look for cells you want to include as interactive widgets.  
    
    
2. Create Widgets in `create_project_info_widgets()`  or `create_modelinputs_widgets()`
    - Go to either:
               `projectinfo_widgets.py` → for `Project Information` fields.
               `modelinputs_widgets.py` → for `Model Inputs` fields.
    - Inside the respective `create_widgets()` function, define the widget using `ipywidgets`.
    - Use appropriate widget types like `FloatText`, `IntText`, `Dropdown`, etc., based on the type of input required.
    
    

3. Replicate Excel Formulas as Python Function (if applicable)
    - Once widgets are created, check whether the corresponding Excel cells are not direct user inputs—i.e., they contain formulas (for example: `1) Project Information'!H38`).
    - If a cell contains a formula, replicate its logic in Python using standard functions like if, and, or, etc.
    - Dependencies differ by sheet:
                In `projectinfo_widgets.py`, most calculated fields rely on constants from `parameters.py` and values from widgets created within the same sheet.
                In `modelinputs_widgets.py`, calculations may depend on a combination of: `Constants` from `parameters.py`, `Inputs` from `projectinfo_widgets.py` or widgets defined in the same Model Inputs section
    - Carefully map out which variables a formula depends on using Excel’s `Name Manager` `(Formulas > Name Manager)` or trace precedents within the sheet.
    
4. Use `.observe()` to Dynamically Update Calculated Fields
    - If your widget’s value is calculated based on others, use `.observe()` to set up reactive behavior.

5. Group Related Widgets with HBox or VBox
    - After creating individual widgets, use HBox to group widgets that should appear in the same row/section.
    - VBox is used at the end to define the vertical layout and control the order in which groups of widgets are displayed on the interface.
    
6. Update `widgets_helper.py`
In this step, we define descriptive information that is used to label and explain the various input fields and widgets across the user interface. This information ensures that the labels, tooltips, and help texts are consistent and informative.
    - Add titles, subtitles, and descriptive bullet points for any new widget sections you introduce.
    - These descriptions help users understand the purpose of each input and when/how to provide data.
    - Use the `Instructions` sheet in the `CalBC Excel model` as your reference for this content, as it often contains detailed explanations for each field.
    - After adding new content in widgets_helper.py, update the line that says from `widgets_helper import ...` in `projectinfo_widgets.py` (around line 15) and in `modelinputs_widgets.py` (around line 8) to include the newly created fields.
    - These imported variables are used in the `create_sections()` function to attach the section title, subtitle, and info bullet points to each group of HBox-wrapped widgets for clear and structured display. For modelinputs_widgets.py, there are also subsections that help organize the inputs into smaller, related groups.
    
    
7. Add to Display Function
    - For `projectinfo_widgets.py`: Add your HBox row to the list of sections being displayed in the `create_section()` function. 
    - For `modelinputs_widgets.py`: Create subsections because there are multiple `peak` and `non-peak` scenarios for both `build` and `no-build` years, and these need to be grouped into smaller, logically organized sections. After defining the subsections, add the HBox row, title, subsection, and section to `create_section_with_subsections()`.  
    - At the end use `widgets.VBox` to stack all the sections. 
    
    

## Workflow to Calculate Metric Benefits
The `CalBC Sketch model` evaluates multiple metrics, including Travel Time, Vehicle Operating Cost, Accident Cost, Emission Cost, and Reliability. The `Travel_time.py` module currently computes `travel time benefits` using inputs and configurations from `parameters.py`, `projectinfo_widgets.py`, and `modelinputs_widgets.py`. In the excel version, each metric—such as Travel Time, Vehicle Operating Cost —follows a standardized layout. Calculations are organized into three sections: `Highway Benefits`, `Transit Benefits`, and a `Total Benefits summary`.
The `Highway Benefits section` includes various traffic scenarios for both peak and non-peak periods. These scenarios cover Peak Period HOV, Non-HOV, Weaving, Truck, Ramp, and Arterial, as well as Non-Peak Period Non-HOV, Weaving, and Truck. The Transit Benefits section typically includes Peak and Non-Peak Period In-Vehicle Transit and Out-of-Vehicle Transit components. However, not all metrics include all four transit components—only those relevant to the specific metric are considered.
Steps: 
- Start a new python script `{metric_name}.py` for the metric you are creating script for. 
- Import the Necessary Libraries.
- Start by importing the necessary modules: `parameters.py`, `projectinfo_widgets.py`, and `modelinputs_widgets.py`, which will provide the input values and parameters for calculations.
- Create a widget for the metric {Example: `travel_time.py` Line 35} and add the display functionality, so that the widget with the metric benefit value is automatically shown when the module is imported. 
- Create a function that calculates the `Average Volume` and `Average Speed` for Year 1 and Year 20 based on values from the imported modules (`modelinputs_widgets`). This should use a volume_dict and speed_dict to map the required values for each scenario (e.g., PHV1NB, PNV1B, etc.).Example Function : `{travel_time.py calculate_combined_average()}`. Note: Safety metric doesn't use `Average Speed`. 
- Once the values for Year 1 and Year 20 are calculated, create a separate function to interpolate the values for the intermediate years (e.g., Year 2 to Year 19). You can use linear interpolation here to fill in the values between Year 1 and Year 20. Example function: `{travel_time.py calculate_trend_for_variables()}`
- Continue developing functions for the remaining intermediate columns to calculate highway travel time benefits. Then, apply the same approach to calculate transit benefits. Finally, calculate the overall travel time benefits by summing the highway and transit benefits.
- Create the main function to execute all necessary steps for calculating the travel time benefits, and set the widget value to the computed metric benefit value, ensuring that the total value is displayed in the widget created earlier. Example function: `{travel_time.py main()}`
- Create a list of all relevant widgets (both for volumes and speeds), and attach an observer to each widget to trigger the main function whenever the widget value changes.


## Add Metric Benefits to BCA calculation
- Now that we have the metric benefit value, import the corresponding metric benefit widget into `BCA.py` and add it to the `benefit_widgets` list. {Line 16 and Line 60}


## Run `Running Widgets.ipynb`
- Open `Running Widgets.ipynb`.
- Start by restarting the kernel to clear any previous variables or imports, ensuring you begin with a clean environment.
- Import any additional metrics or widgets you've created in the notebook (e.g., safety, emissions, etc.), ensuring all necessary components are ready for execution.
- Run all cells to initialize the widgets and calculations. Once completed, the notebook is ready to be launched in `Voila` for interactive use.


## Execute `Voila`
`Voila` is a tool that allows you to turn Jupyter Notebooks into interactive web applications, removing code cells and only displaying the output and widgets to the user. It enables a user-friendly interface where inputs can be modified and results updated dynamically. As of now Voila can only be run from your local machine's terminal, as JupyterHub does not support this feature. 
- To get started, install `Voila` by running `pip install voila` in your terminal.
- Navigate to the folder containing `Running Widgets.ipynb` by using the `cd (change directory)` command in your terminal.
- Run Voila with the command: `"path to voila.exe" Running Widgets.ipynb`.
    - Replace `path to voila.exe` with the actual path. By default, `voila.exe` is typically located in:
      `C:\Users\{Your_s_number}\AppData\Local\Packages\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\LocalCache\local-packages\Python311\Scripts`. Replace `{Your_s_number}` with your actual s-number.







    
    
    
    
    

    

    

    
    
    
    
    
    

    
    





